<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger Pro</title>
    <style>
        :root { --primary: #0084ff; --bg: #f4f7f6; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #app { background: white; width: 100%; max-width: 450px; height: 95vh; border-radius: 15px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; }
        #setup, #chat-room { padding: 20px; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }
        input, select { margin: 8px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; gap: 10px; border-radius: 10px; }
        .msg { padding: 10px; border-radius: 12px; max-width: 85%; font-size: 14px; position: relative; }
        .msg-me { background: #dcf8c6; align-self: flex-end; }
        .msg-other { background: white; align-self: flex-start; }
        .footer { padding: 15px; display: flex; gap: 8px; background: #f0f0f0; align-items: center; }
        .bg-tools { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; font-size: 12px; }
        .color-dot { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 1px solid #999; }
        .img-msg { max-width: 100%; border-radius: 8px; margin-top: 5px; }
        .file-link { display: block; margin-top: 5px; color: #0084ff; text-decoration: none; font-size: 12px; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="app">
    <div class="header">Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù† Ø§Ø®ØªØµØ§ØµÛŒ</div>
    
    <div id="setup">
        <input type="text" id="roomId" placeholder="Ù†Ø§Ù… Ø§ØªØ§Ù‚">
        <input type="text" id="username" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
        <input type="password" id="passcode" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§ØªØ§Ù‚">
        <select id="icon">
            <option value="ğŸ‘¤">ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±</option>
            <option value="ğŸ±">ğŸ± Ú¯Ø±Ø¨Ù‡</option>
            <option value="ğŸ¤–">ğŸ¤– Ø±Ø¨Ø§Øª</option>
            <option value="ğŸ’">ğŸ’ ÙˆÛŒÚ˜Ù‡</option>
        </select>
        <button onclick="joinRoom()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø§ØªØ§Ù‚</button>
        <div id="inviteArea" class="hidden" style="margin-top:15px; font-size:11px; color:#666;">
            Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª: <code id="shareLink" style="background:#eee; display:block; padding:5px;"></code>
        </div>
    </div>

    <div id="chat-room" class="hidden">
        <div class="bg-tools">
            <span>Ø±Ù†Ú¯ Ú†Øª:</span>
            <div class="color-dot" style="background:#e5ddd5" onclick="changeBg('#e5ddd5')"></div>
            <div class="color-dot" style="background:#d1e7ff" onclick="changeBg('#d1e7ff')"></div>
            <div class="color-dot" style="background:#ffd1d1" onclick="changeBg('#ffd1d1')"></div>
        </div>
        <div id="messages"></div>
        <div class="footer">
            <input type="file" id="fileInput" style="display:none" onchange="uploadFile()">
            <button onclick="document.getElementById('fileInput').click()" style="background:#666">ğŸ“</button>
            <input type="text" id="msgInput" placeholder="Ù¾ÛŒØ§Ù…..." style="flex:1">
            <button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const params = new URLSearchParams(window.location.search);
    if(params.has('room')) document.getElementById('roomId').value = params.get('room');

    function changeBg(color) { document.getElementById('messages').style.background = color; }

    function joinRoom() {
        const data = {
            roomId: document.getElementById('roomId').value,
            username: document.getElementById('username').value,
            passcode: document.getElementById('passcode').value,
            icon: document.getElementById('icon').value
        };
        if(data.roomId && data.username && data.passcode) {
            socket.emit('join-room', data);
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('chat-room').classList.remove('hidden');
            document.getElementById('shareLink').innerText = window.location.origin + "?room=" + data.roomId;
            document.getElementById('inviteArea').classList.remove('hidden');
        }
    }

    function uploadFile() {
        const file = document.getElementById('fileInput').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            socket.emit('send-message', {
                roomId: document.getElementById('roomId').value,
                message: "ÙØ§ÛŒÙ„ Ù¾ÛŒÙˆØ³Øª Ø´Ø¯",
                file: e.target.result,
                fileName: file.name,
                fileType: file.type
            });
        };
        reader.readAsDataURL(file);
    }

    function sendMessage() {
        const msg = document.getElementById('msgInput').value;
        if(msg) {
            socket.emit('send-message', { roomId: document.getElementById('roomId').value, message: msg });
            document.getElementById('msgInput').value = "";
        }
    }

    socket.on('new-message', (data) => {
        const div = document.createElement('div');
        const isMe = data.username === document.getElementById('username').value;
        div.className = `msg ${isMe ? 'msg-me' : 'msg-other'}`;
        let content = `<b>${data.icon} ${data.username}</b><br>${data.message}`;
        if(data.file) {
            if(data.fileType.startsWith('image')) content += `<br><img src="${data.file}" class="img-msg">`;
            else content += `<br><a href="${data.file}" download="${data.fileName}" class="file-link">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ${data.fileName}</a>`;
        }
        div.innerHTML = content;
        document.getElementById('messages').appendChild(div);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    });

    socket.on('error-msg', (m) => { alert(m); location.reload(); });
</script>
</body>
</html>

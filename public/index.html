<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Hmmm Chat</title>
<script src="/socket.io/socket.io.js"></script>

<style>
body{
  margin:0;
  font-family:sans-serif;
  background:linear-gradient(135deg,#6366f1,#9333ea);
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.card{
  width:360px;
  background:rgba(255,255,255,.15);
  backdrop-filter:blur(15px);
  border-radius:18px;
  padding:20px;
  color:white;
}

input,button{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  margin-top:10px;
}

button{
  background:#22c55e;
  font-weight:bold;
  cursor:pointer;
}

#chat{display:none}
#messages{
  height:260px;
  overflow-y:auto;
  margin:10px 0;
}
.msg{margin:6px 0}
.system{font-size:12px;color:#fde047}
#typing{font-size:12px;opacity:.7}
</style>
</head>

<body>

<div class="card" id="login">
  <h2>ðŸ”¥ Hmmm Chat</h2>
  <input id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
  <input id="room" placeholder="Ù†Ø§Ù… Ø±ÙˆÙ…">
  <button onclick="join()">ÙˆØ±ÙˆØ¯</button>
  <p id="error"></p>
</div>

<div class="card" id="chat">
  <div id="timer"></div>
  <div id="messages"></div>
  <div id="typing"></div>
  <input id="text" placeholder="Ù¾ÛŒØ§Ù…..." oninput="typingFn()">
  <button onclick="send()">Ø§Ø±Ø³Ø§Ù„</button>
</div>

<audio id="sound" src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3"></audio>

<script>
const socket = io();
let time = 900;
let typingTimer;

function join(){
  socket.emit("join",{
    username:username.value.trim(),
    room:room.value.trim()
  });
}

socket.on("error",msg=>{
  error.innerText = msg;
});

socket.on("history",msgs=>{
  login.style.display="none";
  chat.style.display="block";
  msgs.forEach(addMsg);
  setInterval(()=>{
    time--;
    timer.innerText=`â³ ${Math.floor(time/60)}:${time%60}`;
  },1000);
});

function send(){
  if(text.value.trim()){
    socket.emit("message",text.value);
    text.value="";
    socket.emit("stopTyping");
  }
}

function typingFn(){
  socket.emit("typing");
  clearTimeout(typingTimer);
  typingTimer=setTimeout(()=>{
    socket.emit("stopTyping");
  },1000);
}

socket.on("message",msg=>{
  addMsg(msg);
  sound.play();
});

socket.on("system",msg=>{
  messages.innerHTML+=`<div class="system">${msg}</div>`;
});

socket.on("typing",user=>{
  typing.innerText=`${user} Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾...`;
});

socket.on("stopTyping",()=>{
  typing.innerText="";
});

socket.on("timeup",()=>{
  alert("â›” Ø²Ù…Ø§Ù† Ú†Øª ØªÙ…ÙˆÙ… Ø´Ø¯");
  location.reload();
});

function addMsg(m){
  messages.innerHTML+=
    `<div class="msg"><b>${m.user}</b>: ${m.text} <small>${m.time}</small></div>`;
  messages.scrollTop=messages.scrollHeight;
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øªâ€ŒØ±ÙˆÙ… Ø§Ø®ØªØµØ§ØµÛŒ</title>
    <style>
        :root { --primary: #0084ff; --bg: #f4f7f6; --my-msg: #dcf8c6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #app { background: white; width: 100%; max-width: 450px; height: 90vh; border-radius: 15px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; }
        #setup, #chat-room { padding: 20px; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }
        input, select { margin: 10px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }
        button { padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        button:hover { background: #0056b3; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; gap: 10px; border-radius: 10px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .msg-other { background: white; align-self: flex-start; border-bottom-right-radius: 2px; }
        .msg-me { background: var(--my-msg); align-self: flex-end; border-bottom-left-radius: 2px; }
        .msg-info { font-size: 0.7rem; color: #666; display: block; margin-bottom: 4px; }
        .footer { padding: 15px; display: flex; gap: 10px; background: #f0f0f0; }
        #msgInput { flex: 1; margin: 0; }
        .invite-box { background: #e1f5fe; padding: 10px; border-radius: 8px; margin-top: 15px; border: 1px dashed #039be5; }
        .invite-link { font-size: 0.8rem; color: #0277bd; word-break: break-all; user-select: all; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <div class="header">Ø§ØªØ§Ù‚ Ú¯ÙØªÚ¯Ùˆ</div>
    
    <div id="setup">
        <p style="text-align: center; color: #555;">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØ§Ù‚ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
        <input type="text" id="roomId" placeholder="Ù†Ø§Ù… Ø§ØªØ§Ù‚ (Ù…Ø«Ù„Ø§: MyFamily)">
        <input type="text" id="username" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø´Ù…Ø§">
        <input type="password" id="passcode" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ù¾Ø³Ú©Ø¯)">
        <select id="icon">
            <option value="ğŸ‘¤">ğŸ‘¤ Ù…Ø¹Ù…ÙˆÙ„ÛŒ</option>
            <option value="ğŸ¦Š">ğŸ¦Š Ø±ÙˆØ¨Ø§Ù‡</option>
            <option value="ğŸ¦¸â€â™‚ï¸">ğŸ¦¸â€â™‚ï¸ Ù‚Ù‡Ø±Ù…Ø§Ù†</option>
            <option value="ğŸ‘‘">ğŸ‘‘ Ù„ÛŒØ¯Ø±</option>
            <option value="ğŸ‘»">ğŸ‘» Ø´Ø¨Ø­</option>
        </select>
        <button onclick="joinRoom()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª</button>

        <div id="inviteArea" class="hidden invite-box">
            <span style="font-size: 0.8rem; font-weight: bold;">Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª:</span>
            <div id="shareLink" class="invite-link"></div>
            <p style="font-size: 0.7rem; margin-top: 5px; color: #555;">Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Ù† Ø®ÙˆØ¯ Ø¨ÙØ±Ø³ØªÛŒØ¯.</p>
        </div>
    </div>

    <div id="chat-room" class="hidden">
        <div id="messages"></div>
        <div class="footer">
            <input type="text" id="msgInput" placeholder="Ú†ÛŒØ²ÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    
    // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± ÙÛŒÙ„Ø¯ Ø§ØªØ§Ù‚ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù„ÛŒÙ†Ú© (Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯)
    const params = new URLSearchParams(window.location.search);
    if(params.has('room')) {
        document.getElementById('roomId').value = params.get('room');
    }

    function joinRoom() {
        const roomId = document.getElementById('roomId').value;
        const username = document.getElementById('username').value;
        const passcode = document.getElementById('passcode').value;
        const icon = document.getElementById('icon').value;

        if(!roomId || !username || !passcode) {
            alert("Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… Ù…ÙˆØ§Ø±Ø¯ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯!");
            return;
        }

        socket.emit('join-room', { roomId, username, passcode, icon });
        
        // Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ÛŒØ· Ú†Øª
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('chat-room').classList.remove('hidden');
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø§Ø®ØªØµØ§ØµÛŒ
        const inviteLink = window.location.origin + "?room=" + encodeURIComponent(roomId);
        document.getElementById('inviteArea').classList.remove('hidden');
        document.getElementById('shareLink').innerText = inviteLink;
    }

    function sendMessage() {
        const msgInput = document.getElementById('msgInput');
        const roomId = document.getElementById('roomId').value;
        if(msgInput.value.trim()) {
            socket.emit('send-message', { roomId, message: msgInput.value });
            msgInput.value = "";
        }
    }

    socket.on('new-message', (data) => {
        const messagesDiv = document.getElementById('messages');
        const isMe = data.username === document.getElementById('username').value;
        
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'msg-me' : 'msg-other'}`;
        div.innerHTML = `
            <span class="msg-info">${data.icon} ${data.username}</span>
            <div>${data.message}</div>
        `;
        
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    socket.on('error-msg', (msg) => {
        alert(msg);
        window.location.reload();
    });
</script>
</body>
</html>

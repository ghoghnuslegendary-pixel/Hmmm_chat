<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger Pro Max</title>
    <style>
        :root { --main: #6c5ce7; --bg: #dfe6e9; --chat-bg: #fdfdfd; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; color: #2d3436; }
        #app { background: white; width: 100%; max-width: 480px; height: 92vh; border-radius: 20px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.15); overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        .header { background: var(--main); color: white; padding: 20px; text-align: center; font-size: 1.3rem; font-weight: bold; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #setup, #chat-room { padding: 25px; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }
        input, select { margin-bottom: 15px; padding: 14px; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; transition: 0.3s; background: #f9f9f9; }
        input:focus { border-color: var(--main); outline: none; background: white; box-shadow: 0 0 8px rgba(108, 92, 231, 0.2); }
        button { padding: 14px; background: var(--main); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4); }
        #messages { flex: 1; overflow-y: auto; padding: 15px; background: #f0f2f5; display: flex; flex-direction: column; gap: 12px; border-radius: 15px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 80%; font-size: 14px; line-height: 1.5; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-me { background: var(--main); color: white; align-self: flex-end; border-bottom-left-radius: 4px; }
        .msg-other { background: white; align-self: flex-start; border-bottom-right-radius: 4px; }
        .msg-info { font-size: 11px; opacity: 0.8; margin-bottom: 4px; display: block; }
        .footer { padding: 15px; display: flex; gap: 10px; background: white; align-items: center; border-top: 1px solid #eee; }
        .tool-bar { display: flex; justify-content: space-around; padding: 10px; background: #f9f9f9; border-radius: 10px; margin-bottom: 10px; }
        .color-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .img-preview { max-width: 100%; border-radius: 10px; margin-top: 8px; border: 1px solid rgba(0,0,0,0.1); }
        .file-box { background: rgba(0,0,0,0.05); padding: 10px; border-radius: 10px; display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit; font-size: 12px; margin-top: 5px; }
        #loading { font-size: 12px; color: var(--main); text-align: center; display: none; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="app">
    <div class="header">ğŸ’ Messenger Elite</div>
    
    <div id="setup">
        <input type="text" id="roomId" placeholder="Ù†Ø§Ù… Ø§ØªØ§Ù‚ (Ù…Ø«Ù„Ø§Ù‹: PrivateBox)">
        <input type="text" id="username" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
        <input type="password" id="passcode" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <label style="font-size: 12px; color: #666; margin-bottom: 5px;">Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÛŒÚ©ÙˆÙ† Ø´Ù…Ø§:</label>
        <select id="icon">
            <option value="ğŸ‘¤">ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± Ø³Ø§Ø¯Ù‡</option>
            <option value="ğŸ¥·">ğŸ¥· Ù†ÛŒÙ†Ø¬Ø§</option>
            <option value="ğŸ‘‘">ğŸ‘‘ Ù¾Ø§Ø¯Ø´Ø§Ù‡</option>
            <option value="ğŸ‘»">ğŸ‘» Ø±ÙˆØ­</option>
            <option value="ğŸ¤–">ğŸ¤– Ø±Ø¨Ø§Øª</option>
            <option value="ğŸ±">ğŸ± Ú¯Ø±Ø¨Ù‡</option>
            <option value="ğŸš€">ğŸš€ Ù…ÙˆØ´Ú©</option>
            <option value="ğŸ”¥">ğŸ”¥ Ø¢ØªØ´ÛŒÙ†</option>
            <option value="ğŸ¦„">ğŸ¦„ ÛŒÙˆÙ†ÛŒÚ©ÙˆØ±Ù†</option>
            <option value="ğŸ’">ğŸ’ Ø§Ù„Ù…Ø§Ø³</option>
            <option value="ğŸ¤¡">ğŸ¤¡ Ø¬ÙˆÚ©Ø±</option>
            <option value="ğŸ‘½">ğŸ‘½ ÙØ¶Ø§ÛŒÛŒ</option>
            <option value="ğŸ¼">ğŸ¼ Ù¾Ø§Ù†Ø¯Ø§</option>
            <option value="ğŸ˜">ğŸ˜ Ø¨Ø§Ú©Ù„Ø§Ø³</option>
            <option value="ğŸŒŸ">ğŸŒŸ Ø³ØªØ§Ø±Ù‡</option>
        </select>
        <button onclick="joinRoom()">Ø§ÛŒØ¬Ø§Ø¯ Ùˆ ÙˆØ±ÙˆØ¯</button>
        <div id="inviteArea" class="hidden" style="margin-top:20px; padding:10px; background:#fff3cd; border-radius:10px; font-size:11px;">
            <b>Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø§Ø®ØªØµØ§ØµÛŒ:</b>
            <code id="shareLink" style="display:block; margin-top:5px; color:#856404;"></code>
        </div>
    </div>

    <div id="chat-room" class="hidden">
        <div class="tool-bar">
            <div class="color-btn" style="background:#f0f2f5" onclick="setBg('#f0f2f5')"></div>
            <div class="color-btn" style="background:#ffeaa7" onclick="setBg('#ffeaa7')"></div>
            <div class="color-btn" style="background:#fab1a0" onclick="setBg('#fab1a0')"></div>
            <div class="color-btn" style="background:#a29bfe" onclick="setBg('#a29bfe')"></div>
            <div class="color-btn" style="background:#55efc4" onclick="setBg('#55efc4')"></div>
        </div>
        <div id="loading">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ Ø³Ù†Ú¯ÛŒÙ†... â³</div>
        <div id="messages"></div>
        <div class="footer">
            <input type="file" id="fileInput" style="display:none" onchange="uploadFile()">
            <button onclick="document.getElementById('fileInput').click()" style="background:#636e72; border-radius: 50%; width: 45px; height: 45px; padding: 0;">ğŸ“</button>
            <input type="text" id="msgInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." style="flex:1; margin-bottom:0" onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" style="border-radius: 50%; width: 45px; height: 45px; padding: 0;">âœˆï¸</button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const params = new URLSearchParams(window.location.search);
    if(params.has('room')) document.getElementById('roomId').value = params.get('room');

    function setBg(color) { document.getElementById('messages').style.background = color; }

    function joinRoom() {
        const d = {
            roomId: document.getElementById('roomId').value,
            username: document.getElementById('username').value,
            passcode: document.getElementById('passcode').value,
            icon: document.getElementById('icon').value
        };
        if(d.roomId && d.username && d.passcode) {
            socket.emit('join-room', d);
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('chat-room').classList.remove('hidden');
            document.getElementById('shareLink').innerText = window.location.origin + "?room=" + encodeURIComponent(d.roomId);
            document.getElementById('inviteArea').classList.remove('hidden');
        } else { alert("Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯!"); }
    }

    function uploadFile() {
        const file = document.getElementById('fileInput').files[0];
        if(!file) return;
        if(file.size > 200 * 1024 * 1024) return alert("Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨Ø§Ù„Ø§ÛŒ Û²Û°Û° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø§Ø³Øª!");
        
        document.getElementById('loading').style.display = 'block';
        const reader = new FileReader();
        reader.onload = (e) => {
            socket.emit('send-message', {
                roomId: document.getElementById('roomId').value,
                message: "ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: " + file.name,
                file: e.target.result,
                fileName: file.name,
                fileType: file.type
            });
            document.getElementById('loading').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }

    function sendMessage() {
        const msg = document.getElementById('msgInput').value;
        if(msg.trim()) {
            socket.emit('send-message', { roomId: document.getElementById('roomId').value, message: msg });
            document.getElementById('msgInput').value = "";
        }
    }

    socket.on('new-message', (data) => {
        const mDiv = document.getElementById('messages');
        const isMe = data.username === document.getElementById('username').value;
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'msg-me' : 'msg-other'}`;
        
        let content = `<span class="msg-info">${data.icon} ${data.username}</span>${data.message}`;
        if(data.file) {
            if(data.fileType.startsWith('image')) {
                content += `<br><img src="${data.file}" class="img-preview" onclick="window.open(this.src)">`;
            } else {
                content += `<br><a href="${data.file}" download="${data.fileName}" class="file-box">ğŸ“¦ ${data.fileName} (Ø¯Ø±ÛŒØ§ÙØª)</a>`;
            }
        }
        div.innerHTML = content;
        mDiv.appendChild(div);
        mDiv.scrollTop = mDiv.scrollHeight;
    });

    socket.on('error-msg', (m) => { alert(m); location.reload(); });
</script>
</body>
</html>
